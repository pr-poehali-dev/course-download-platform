# Nginx configuration для React SPA с правильной обработкой 404
# Этот файл нужно использовать при деплое на Nginx сервер

server {
    listen 80;
    listen [::]:80;
    server_name techforma.pro www.techforma.pro;

    # Редирект с www на без www
    if ($host = www.techforma.pro) {
        return 301 https://techforma.pro$request_uri;
    }

    # Редирект на HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name techforma.pro;

    # SSL сертификаты (настройте пути к вашим сертификатам)
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    root /var/www/techforma/dist;
    index index.html;

    # Сжатие
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;
    gzip_min_length 1000;

    # Кеширование статических файлов
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Основная обработка запросов
    location / {
        # Сначала пробуем найти файл
        try_files $uri $uri/ @router;
    }

    # Если файл не найден - проверяем, это маршрут React или несуществующая страница
    location @router {
        # Список известных маршрутов React
        set $react_route 0;
        
        # Главная и основные страницы
        if ($uri ~ ^/$) { set $react_route 1; }
        if ($uri ~ ^/catalog) { set $react_route 1; }
        if ($uri ~ ^/work/) { set $react_route 1; }
        if ($uri ~ ^/profile) { set $react_route 1; }
        if ($uri ~ ^/login) { set $react_route 1; }
        if ($uri ~ ^/register) { set $react_route 1; }
        if ($uri ~ ^/blog) { set $react_route 1; }
        if ($uri ~ ^/admin) { set $react_route 1; }
        if ($uri ~ ^/marketplace) { set $react_route 1; }
        if ($uri ~ ^/upload) { set $react_route 1; }
        if ($uri ~ ^/buy-points) { set $react_route 1; }
        if ($uri ~ ^/defense-kit) { set $react_route 1; }
        if ($uri ~ ^/contacts) { set $react_route 1; }
        if ($uri ~ ^/privacy-policy) { set $react_route 1; }
        if ($uri ~ ^/terms-of-service) { set $react_route 1; }
        if ($uri ~ ^/usage-rules) { set $react_route 1; }
        if ($uri ~ ^/offer) { set $react_route 1; }
        if ($uri ~ ^/requisites) { set $react_route 1; }
        if ($uri ~ ^/payment) { set $react_route 1; }
        if ($uri ~ ^/forgot-password) { set $react_route 1; }
        if ($uri ~ ^/reset-password) { set $react_route 1; }
        
        # Если это известный маршрут React - отдаём index.html
        if ($react_route = 1) {
            rewrite ^ /index.html last;
        }
        
        # Если неизвестный маршрут - отдаём 404.html со статусом 404
        return 404 /404.html;
    }

    # Обработка 404 ошибок
    error_page 404 /404.html;
    location = /404.html {
        internal;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}
