# üìä –û—Ç—á—ë—Ç –æ —Å–∏—Å—Ç–µ–º–µ –±–∞–ª–ª–æ–≤ TechForma

## ‚úÖ –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

### 1. **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–±–æ—Ç—ã**
**–§–∞–π–ª:** `backend/purchase-work/index.py`  
**–°—Ç—Ä–æ–∫–∏:** 225-238

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É —Ä–∞–±–æ—Ç—ã –∏–∑ –ë–î (—Å—Ç—Ä–æ–∫–∞ 87)
cur.execute("SELECT price_points FROM works WHERE id = %s", (work_id,))

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (—Å—Ç—Ä–æ–∫–∏ 144-169)
if balance < price:
    return error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤')

# 3. –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã (—Å—Ç—Ä–æ–∫–∏ 227-230)
cur.execute("UPDATE users SET balance = balance - %s WHERE id = %s", (price, user_id))

# 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Å—Ç—Ä–æ–∫–∏ 233-238)
cur.execute("""
    INSERT INTO transactions (user_id, amount, type, description)
    VALUES (%s, %s, 'purchase', %s)
""", (user_id, -price, f'–ü–æ–∫—É–ø–∫–∞ —Ä–∞–±–æ—Ç—ã #{work_id}'))
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞:**
- ‚úÖ –¶–µ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –ë–î (—Å—Ç—Ä–æ–∫–∞ 104), –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ü–µ–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ê–≤—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –∫—É–ø–∏—Ç—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É (—Å—Ç—Ä–æ–∫–∏ 119-126)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–∫—É–ø–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 188-223)
- ‚úÖ –õ–∏–º–∏—Ç 10 –ø–æ–∫—É–ø–æ–∫ –≤ —á–∞—Å (—Å—Ç—Ä–æ–∫–∏ 172-185)

---

### 2. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∞–≤—Ç–æ—Ä—É (90%)**
**–§–∞–π–ª:** `backend/purchase-work/index.py`  
**–°—Ç—Ä–æ–∫–∏:** 252-277

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
# 1. –í—ã—á–∏—Å–ª—è–µ–º –¥–æ–ª—é –∞–≤—Ç–æ—Ä–∞: 90% (—Å—Ç—Ä–æ–∫–∞ 254)
author_share = int(price * 0.90)
platform_fee = int(price * 0.10)

# 2. –ù–∞—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ—Ä—É (—Å—Ç—Ä–æ–∫–∏ 258-261)
cur.execute("UPDATE users SET balance = balance + %s WHERE id = %s", (author_share, author_id))

# 3. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ—Ä—É (—Å—Ç—Ä–æ–∫–∏ 272-277)
cur.execute("""
    INSERT INTO transactions (user_id, amount, type, description)
    VALUES (%s, %s, 'sale', %s)
""", (author_id, author_share, f'–ü—Ä–æ–¥–∞–∂–∞ —Ä–∞–±–æ—Ç—ã #{work_id} (–∫–æ–º–∏—Å—Å–∏—è 10%)'))

# 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ author_earnings (—Å—Ç—Ä–æ–∫–∏ 264-269)
cur.execute("""
    INSERT INTO author_earnings (author_id, work_id, purchase_id, sale_amount, author_share, platform_fee, status)
    VALUES (%s, %s, %s, %s, %s, %s, 'paid')
""", (author_id, work_id, purchase_id, price, author_share, platform_fee))
```

---

### 3. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞**
**–§–∞–π–ª:** `backend/payment/index.py`  
**–°—Ç—Ä–æ–∫–∏:** 311-325

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –∏–∑ –ø–∞–∫–µ—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 276-280)
package = BALANCE_PACKAGES[package_id]
points = package['points'] + package['bonus']  # –±–∞–∑–æ–≤—ã–µ + –±–æ–Ω—É—Å–Ω—ã–µ

# 2. –ù–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã (—Å—Ç—Ä–æ–∫–∏ 312-316)
cur.execute("""
    UPDATE users SET balance = balance + %s WHERE id = %s
""", (points, user_id))

# 3. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Å—Ç—Ä–æ–∫–∏ 321-325)
cur.execute("""
    INSERT INTO transactions (user_id, amount, type, description)
    VALUES (%s, %s, 'balance_topup', %s)
""", (user_id, points, f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¢–∏–Ω—å–∫–æ—Ñ—Ñ: {points} –±–∞–ª–ª–æ–≤'))

# 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–ª–∞—Ç—ë–∂ –≤ —Ç–∞–±–ª–∏—Ü—É payments (—Å—Ç—Ä–æ–∫–∏ 330-334)
cur.execute("""
    INSERT INTO payments (user_email, points, amount, payment_id, status, created_at)
    VALUES (%s, %s, %s, %s, 'succeeded', NOW())
""", (user_email, points, amount_rubles, payment_id))
```

**–ü–∞–∫–µ—Ç—ã –±–∞–ª–ª–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 24-29):**
```python
BALANCE_PACKAGES = {
    '100':  {'points': 100,  'price': 500,   'bonus': 10},   # 110 –±–∞–ª–ª–æ–≤ –∑–∞ 500‚ÇΩ
    '600':  {'points': 600,  'price': 3000,  'bonus': 100},  # 700 –±–∞–ª–ª–æ–≤ –∑–∞ 3000‚ÇΩ
    '1500': {'points': 1500, 'price': 7500,  'bonus': 300},  # 1800 –±–∞–ª–ª–æ–≤ –∑–∞ 7500‚ÇΩ
    '3000': {'points': 3000, 'price': 15000, 'bonus': 700},  # 3700 –±–∞–ª–ª–æ–≤ –∑–∞ 15000‚ÇΩ
}
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä–∫–∞ `payment_id` –≤ –ë–î (—Å—Ç—Ä–æ–∫–∏ 288-300)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ webhook retry

---

### 4. **–ë–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**
**–§–∞–π–ª:** `backend/auth/index.py`  
**–°—Ç—Ä–æ–∫–∏:** 199-217

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
# 1. –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–∞–ª–∞–Ω—Å–æ–º 1000 (—Å—Ç—Ä–æ–∫–∞ 206)
cur.execute("""
    INSERT INTO users (username, email, password_hash, referral_code, balance, ...) 
    VALUES (%s, %s, %s, %s, 1000, ...)
    RETURNING id
""", (username, email, password_hash, referral_code, ...))

# 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Å—Ç—Ä–æ–∫–∏ 210-217)
cur.execute("""
    INSERT INTO transactions (user_id, type, amount, description) 
    VALUES (%s, 'refill', 1000, '–ë–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
""", (user_id,))
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—É–∑–∞:**
- ‚úÖ –õ–∏–º–∏—Ç 3 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –æ–¥–Ω–æ–≥–æ IP –∑–∞ 24 —á–∞—Å–∞ (—Å—Ç—Ä–æ–∫–∏ 169-193)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email/username (—Å—Ç—Ä–æ–∫–∏ 155-167)

---

## üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (transactions)

**–¢–∞–±–ª–∏—Ü–∞:** `t_p63326274_course_download_plat.transactions`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
- id: integer (PK)
- user_id: integer (FK ‚Üí users.id)
- type: varchar(20)  -- 'purchase', 'sale', 'refill', 'balance_topup', 'deduction'
- amount: integer    -- –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏–π
- description: text  -- –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- created_at: timestamp
```

**–¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π:**
1. **`purchase`** ‚Äî —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–±–æ—Ç—ã (amount –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π)
2. **`sale`** ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—É –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ä–∞–±–æ—Ç—ã (amount –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π, 90% –æ—Ç —Ü–µ–Ω—ã)
3. **`refill`** ‚Äî –±–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (amount = 1000)
4. **`balance_topup`** ‚Äî –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É (amount = points + bonus)
5. **`deduction`** ‚Äî –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è (–≤–æ–∑–≤—Ä–∞—Ç—ã, —à—Ç—Ä–∞—Ñ—ã)

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `test_points_system.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
1. ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `transactions` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. ‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–±–æ—Ç—ã
4. ‚úÖ –ó–∞–ø–∏—Å—å –æ —Å–ø–∏—Å–∞–Ω–∏–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `transactions`
5. ‚úÖ –ë–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∞–Ω
6. ‚ö†Ô∏è –í—ã–ø–ª–∞—Ç–∞ –∞–≤—Ç–æ—Ä—É (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

**1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```sql
SELECT * FROM t_p63326274_course_download_plat.transactions 
WHERE user_id = 1000023 
ORDER BY created_at DESC;
```

**2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–ª–∞—Ç—ã –∞–≤—Ç–æ—Ä–∞–º:**
```sql
SELECT 
    ae.author_id,
    u.username,
    ae.sale_amount,
    ae.author_share,
    ae.platform_fee,
    ae.created_at
FROM t_p63326274_course_download_plat.author_earnings ae
JOIN t_p63326274_course_download_plat.users u ON ae.author_id = u.id
ORDER BY ae.created_at DESC
LIMIT 10;
```

**3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –¥–æ/–ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏:**
```sql
-- –ë–∞–ª–∞–Ω—Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
SELECT balance FROM t_p63326274_course_download_plat.users WHERE id = 1000023;

-- –ü–æ–∫—É–ø–∫–∞ —Ä–∞–±–æ—Ç—ã (—á–µ—Ä–µ–∑ purchase-work API)

-- –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ (–¥–æ–ª–∂–µ–Ω —É–º–µ–Ω—å—à–∏—Ç—å—Å—è –Ω–∞ price_points —Ä–∞–±–æ—Ç—ã)
SELECT balance FROM t_p63326274_course_download_plat.users WHERE id = 1000023;
```

---

## ‚úÖ –í—ã–≤–æ–¥

–°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. ‚úÖ **–°–ø–∏—Å–∞–Ω–∏–µ:** –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ + –∑–∞–ø–∏—Å—å –≤ `transactions`
2. ‚úÖ **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—É:** 90% –æ—Ç —Ü–µ–Ω—ã + –∑–∞–ø–∏—Å—å –≤ `transactions` –∏ `author_earnings`
3. ‚úÖ **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:** –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã + –∑–∞–ø–∏—Å—å –≤ `transactions` –∏ `payments`
4. ‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** 1000 –±–∞–ª–ª–æ–≤ + –∑–∞–ø–∏—Å—å –≤ `transactions`
5. ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è:** –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `transactions`
6. ‚úÖ **–ó–∞—â–∏—Ç–∞:** –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã –∏–∑ –ë–î, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π, –ª–∏–º–∏—Ç—ã –ø–æ–∫—É–ø–æ–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–∏—á–Ω—ã–º –∫–∞–±–∏–Ω–µ—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤")
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
