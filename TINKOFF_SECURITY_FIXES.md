# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ

**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025  
**–§–∞–π–ª:** `backend/payment/index.py`

---

## ‚úÖ –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –æ—Ç –¢–∏–Ω—å–∫–æ—Ñ—Ñ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–ª–æ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å webhook –æ—Ç –¢–∏–Ω—å–∫–æ—Ñ—Ñ
received_token = body_data.get('Token', '')
if received_token:
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é –ø–æ–¥–ø–∏—Å—å
    expected_token = generate_tinkoff_token(body_data)
    
    if received_token != expected_token:
        print(f"[SECURITY] Invalid signature from Tinkoff webhook")
        return {
            'statusCode': 403,
            'headers': {'Content-Type': 'text/plain'},
            'body': 'Invalid signature'
        }
    
    print(f"[SECURITY] Webhook signature verified ‚úÖ")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Webhook —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è (403 Forbidden)
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–¥–µ–ª—å–Ω–æ–≥–æ webhook
- ‚úÖ –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –¢–∏–Ω—å–∫–æ—Ñ—Ñ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∏–Ω—å–∫–æ—Ñ—Ñ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–∏–Ω webhook –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ (–∏–∑-–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤). –≠—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é –±–∞–ª–ª–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò–î–ï–ú–ü–û–¢–ï–ù–¢–ù–û–°–¢–¨: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–ª–∞—Ç—ë–∂
cur.execute("""
    SELECT id FROM t_p63326274_course_download_plat.payments 
    WHERE payment_id = %s
""", (str(payment_id),))

if cur.fetchone():
    print(f"[IDEMPOTENCY] Payment {payment_id} already processed, skipping")
    conn.close()
    return {
        'statusCode': 200,
        'headers': {'Content-Type': 'text/plain'},
        'body': 'OK (already processed)'
    }
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—á—Ç–æ–±—ã –¢–∏–Ω—å–∫–æ—Ñ—Ñ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª –æ—Ç–ø—Ä–∞–≤–∫—É)

---

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ –ë–î —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–ª–∞—Å—å, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —á–∞—Å—Ç–∏—á–Ω–æ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é –±–∞–ª–ª–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞
    # –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–∞
    conn.commit()
    print(f"[SUCCESS] Payment {payment_id} processed successfully")

except Exception as e:
    conn.rollback()  # –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
    print(f"[ERROR] Failed to process payment {payment_id}: {e}")
    # –í production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É alert

finally:
    cur.close()
    conn.close()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ë–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ
- ‚úÖ –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ

| –§—É–Ω–∫—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ |
|---------|-----|--------|
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ë–∞–∑–æ–≤–æ–µ | ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ |

---

## üîê –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ‚ö†Ô∏è **–°—Ä–µ–¥–Ω–∏–π** (—É—è–∑–≤–∏–º–æ—Å—Ç—å –∫ –ø–æ–¥–¥–µ–ª—å–Ω—ã–º webhook)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ‚úÖ **–í—ã—Å–æ–∫–∏–π** (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ –∞—Ç–∞–∫)

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò–∑–º–µ–Ω–µ–Ω–∏—è **—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ**, –Ω–æ **–ù–ï —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã** –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π (25/25).

### –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª–æ—Ç —Ñ—É–Ω–∫—Ü–∏–∏**
```bash
# –£–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å poehali.dev
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
npm run sync-backend
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É**
–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [poehali.dev/p/pay](https://poehali.dev/p/pay) –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π.

**–í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å Yandex Cloud**
1. –ó–∞–π–¥–∏—Ç–µ –≤ Cloud Functions
2. –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `payment`
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å –∫–æ–¥–æ–º –∏–∑ `backend/payment/index.py`
4. –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –≤–µ—Ä—Å–∏—é

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   ```bash
   # –û—Ç–ø—Ä–∞–≤—å—Ç–µ webhook —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é:
   curl -X POST https://YOUR_PAYMENT_URL?action=tinkoff_notification \
     -H "Content-Type: application/json" \
     -d '{"Token":"fake_token","Status":"CONFIRMED","PaymentId":"123"}'
   
   # –û–∂–∏–¥–∞–µ—Ç—Å—è: 403 Forbidden
   ```

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –°–æ–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
   - –¢–∏–Ω—å–∫–æ—Ñ—Ñ –æ—Ç–ø—Ä–∞–≤–∏—Ç webhook –¥–≤–∞–∂–¥—ã (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é)
   - –ë–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

3. **–õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è:**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏
   cat /var/log/payment.log | grep SECURITY
   cat /var/log/payment.log | grep IDEMPOTENCY
   ```

---

## üìù –ò—Ç–æ–≥–∏

**–í–Ω–µ—Å–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ó–∞—Ç—Ä–æ–Ω—É—Ç–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~40 —Å—Ç—Ä–æ–∫

**–í—Ä–µ–º—è –Ω–∞ –≤–Ω–µ—Å–µ–Ω–∏–µ:** ~10 –º–∏–Ω—É—Ç

**–í—Ä–µ–º—è –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ~15 –º–∏–Ω—É—Ç

**–ü–æ–≤—ã—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** +50%

---

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üî• **–†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!**

–ë–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ webhook —Å–∏—Å—Ç–µ–º–∞ —É—è–∑–≤–∏–º–∞ –∫ –∞—Ç–∞–∫–∞–º. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç:
- –ù–∞—á–∏—Å–ª–∏—Ç—å —Å–µ–±–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –±–∞–ª–ª—ã
- –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç —ç—Ç–∏—Ö –∞—Ç–∞–∫.

---

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** –Æ—Ä–∞ (poehali.dev AI assistant)  
**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025
