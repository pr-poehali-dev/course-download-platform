#!/bin/bash

################################################################################
# –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./scripts/restore_db.sh /path/to/backup_20250110_030000.sql.gz
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PostgreSQL client (psql)
#   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL
#   - –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (.sql.gz)
################################################################################

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ $# -eq 0 ]; then
    echo -e "${RED}‚ùå ERROR: –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 /path/to/backup.sql.gz"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã:"
    ls -lh /backups/postgres/backup_*.sql.gz 2>/dev/null || echo "–ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

BACKUP_FILE="$1"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
if [ ! -f "$BACKUP_FILE" ]; then
    echo -e "${RED}‚ùå ERROR: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_FILE${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo -e "${RED}‚ùå ERROR: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞${NC}"
    exit 1
fi

echo -e "${YELLOW}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ!${NC}"
echo "–§–∞–π–ª –±—ç–∫–∞–ø–∞: $BACKUP_FILE"
echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DATABASE_URL"
echo ""
read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (–≤–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 0
fi

echo ""
echo -e "${GREEN}üöÄ –ù–∞—á–∏–Ω–∞—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞..."
if ! gzip -t "$BACKUP_FILE" 2>/dev/null; then
    echo -e "${RED}‚ùå ERROR: –ê—Ä—Ö–∏–≤ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω${NC}"
    exit 1
fi

echo "‚úÖ –ê—Ä—Ö–∏–≤ –≤–∞–ª–∏–¥–Ω—ã–π"

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
START_TIME=$(date +%s)

if gunzip -c "$BACKUP_FILE" | psql "$DATABASE_URL"; then
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    
    echo ""
    echo -e "${GREEN}‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo "–í—Ä–µ–º—è: ${DURATION}s"
else
    echo -e "${RED}‚ùå ERROR: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏${NC}"
    exit 1
fi

exit 0
