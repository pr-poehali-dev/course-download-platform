#!/bin/bash

################################################################################
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# 
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./scripts/backup_db.sh
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PostgreSQL client (pg_dump)
#   - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL
#   - –ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /backups
################################################################################

set -e  # –í—ã–π—Ç–∏ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BACKUP_DIR="${BACKUP_DIR:-/backups/postgres}"
RETENTION_DAYS="${RETENTION_DAYS:-7}"  # –•—Ä–∞–Ω–∏—Ç—å 7 –¥–Ω–µ–π
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_$DATE.sql.gz"
LOG_FILE="${LOG_FILE:-/var/log/postgres_backup.log}"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo -e "${RED}‚ùå ERROR: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL"
    echo "–ü—Ä–∏–º–µ—Ä: export DATABASE_URL='postgresql://user:pass@host:5432/dbname'"
    exit 1
fi

# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$BACKUP_DIR" ]; then
    log "${YELLOW}–°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $BACKUP_DIR${NC}"
    mkdir -p "$BACKUP_DIR"
fi

log "${GREEN}üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
if ! psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
    log "${RED}‚ùå ERROR: –ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö${NC}"
    exit 1
fi

log "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ"

# –í—ã–ø–æ–ª–Ω–∏—Ç—å backup
log "–°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
START_TIME=$(date +%s)

if pg_dump "$DATABASE_URL" | gzip > "$BACKUP_FILE"; then
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    FILE_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    
    log "${GREEN}‚úÖ Backup —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
    log "–§–∞–π–ª: $BACKUP_FILE"
    log "–†–∞–∑–º–µ—Ä: $FILE_SIZE"
    log "–í—Ä–µ–º—è: ${DURATION}s"
else
    log "${RED}‚ùå ERROR: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ backup${NC}"
    rm -f "$BACKUP_FILE"  # –£–¥–∞–ª–∏—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏–≤–∞
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞..."
if gzip -t "$BACKUP_FILE" 2>/dev/null; then
    log "‚úÖ –ê—Ä—Ö–∏–≤ –≤–∞–ª–∏–¥–Ω—ã–π"
else
    log "${RED}‚ùå ERROR: –ê—Ä—Ö–∏–≤ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω${NC}"
    exit 1
fi

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã
log "–£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ $RETENTION_DAYS –¥–Ω–µ–π..."
DELETED_COUNT=$(find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete -print | wc -l)

if [ "$DELETED_COUNT" -gt 0 ]; then
    log "–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤: $DELETED_COUNT"
else
    log "–°—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤
log "–¢–µ–∫—É—â–∏–µ –±—ç–∫–∞–ø—ã:"
ls -lh "$BACKUP_DIR"/backup_*.sql.gz | tail -n 5 | tee -a "$LOG_FILE"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# if command -v aws &> /dev/null; then
#     log "–ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3..."
#     aws s3 cp "$BACKUP_FILE" "s3://your-bucket/postgres-backups/" && \
#         log "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ S3"
# fi

log "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!${NC}"

# –í—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
echo ""
echo "=========================================="
echo "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
echo "=========================================="
echo "–§–∞–π–ª: $BACKUP_FILE"
echo "–†–∞–∑–º–µ—Ä: $FILE_SIZE"
echo "–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${DURATION}s"
echo "=========================================="

exit 0
